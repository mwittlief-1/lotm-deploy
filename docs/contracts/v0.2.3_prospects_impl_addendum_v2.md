# v0.2.3 Prospects — CTO Implementation Addendum v2 (NO DISCRETION)
**Last Updated:** 2026-02-14  
**Status:** Binding for v0.2.3 build

---

## A) Absolute copy locks
### A1) Prospect.summary (exact strings)
Set `Prospect.summary` to exactly one of:
- `"Marriage proposal"`
- `"Grant offer"`
- `"Inheritance claim"`

No other prose.

### A2) Requirements
`requirements = []` always in v0.2.3 (so `Requirement.text` is never needed).

---

## B) Generation rules (trigger-only; deterministic)
ProspectsWindow may contain 0–N prospects, with **N ≤ 3**.

### B1) marriage prospect
Generate **one** marriage prospect **only if** MarriageWindow exists (eligible child + offers).
- `subject_person_id`: first eligible child id in `eligible_child_ids` (sorted asc)
- Offer selection: choose the **best** offer by the SAME scoring rule used by v0.2.2 policy marriage acceptance (tie-break offer_index asc)
- `from_house_id`: `pickSponsorHouseId(state)` (Section D)
- `predicted_effects`:
  - `coin_delta = offer.dowry_coin_net`
  - `relationship_deltas` derived from offer deltas (person-scope)
  - `flags_set = []`
- `costs = {}` (empty)
- `uncertainty = "known"`
- `expires_turn = turn_index + 2`

### B2) grant prospect
Generate **one** grant prospect **only if** arrears > 0 (coin or bushels).
- `subject_person_id = null`
- `from_house_id = pickSponsorHouseId(state)`
- `predicted_effects = {}` (empty), `costs = {}` (empty)
- `uncertainty = "likely"`
- `expires_turn = turn_index + 2`

### B3) inheritance_claim prospect
Generate **one** inheritance_claim prospect **only if** `state.house.heir_id` is null (or computed heir is null).
- `subject_person_id = state.house.head.id`
- `from_house_id = pickSponsorHouseId(state)`
- `predicted_effects.flags_set = ["inheritance_claim_active"]` (only)
- others empty, `costs = {}`
- `uncertainty = "possible"`
- `expires_turn = turn_index + 1`

No other generation. No random chances.

---

## C) Apply rules (accept/reject; minimal effects)
### C1) Accept
Apply ONLY what is present in the prospect payload + one explicit marriage effect:
- If type=marriage: set `people[subject_person_id].married = true`
- Apply `coin_delta` if present to manor.coin
- Apply relationship deltas if present
- Set flags in flags_set if present
- Do not move/create people; no holdings changes

### C2) Reject
No-op unless relationship_deltas exist.

---

## D) Sponsor house selection (from_house_id; deterministic; no mapping guesses)
Because v0.2.2 marriage offers originate from local nobles (not houses), we do NOT map noble→house.

`pickSponsorHouseId(state)`:
- choose external house with highest directed Respect edge: `player_head_id → external_head_id`
- tie-break by `house_id` asc
- if none exist, use `state.player_house_id`

---

## E) Relevance filtering (presentation-only; deterministic)
Show if:
- involves player household person, OR
- sponsor relationship Respect ≥ 55 (directed head→head), OR
- expires this turn

Log shown_ids/hidden_ids in `prospects_window_built`.

---

## F) Expiry
Expire when `turn_index > expires_turn` (checked at start of turn). Emit `prospect_expired` once and remove from active list.

---

## G) Storage and logging
- Store only `{id, expires_turn}` in `state.flags._prospects_active_v1` (bounded).
- Do NOT store full prospect payloads in flags.
- Emit structured events with exact names (per CPO lock).
- UI must render from structured events (no sim-generated free-text notes). BE may adjust App.tsx minimally to read structured logs using existing COPY constants (no new strings).

---

## H) Preflight (do not rewrite)
Use DevB `preflightNoDeps.mjs` and baseline file as-is. Do not regenerate/expand baseline format.
