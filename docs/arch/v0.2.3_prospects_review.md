# v0.2.3 Prospects MVP — TA Review (Determinism + Non‑Perturbation + Bounded State)
**Last Updated:** 2026-02-14 (America/Indiana/Indianapolis)

**Baseline BUILD_INFO (v0.2.2 certified):**
- app_version: `v0.2.2`
- sim_version: `mvp_v0_1`
- **code_fingerprint:** `edf67fcfbbac7a3c2b368c43fd7f8c26a01be39fc69fbc3bb70ecaa4b75f10d5`

**Inputs reviewed:**
- `lotm_v0.2.2_repo_CERTIFIED_QA.zip` (baseline)
- `lotm_v0.2.3_kickoff_contract_first.zip`
  - `docs/contracts/v0.2.3_prospects_contract.md` (LOCKED; `prospects_window_v1`)

---

## Summary
v0.2.3 adds a deterministic **Prospects MVP** (types: `marriage`, `grant`, `inheritance_claim` claim‑only) plus **presentation‑only relevance filtering** with required logging of `shown_ids`/`hidden_ids`.

**Explicitly NOT in v0.2.3 (locked non‑goals):** info‑cost mechanics, multi‑manor/holdings grants, new routes/screens beyond a minimal panel/section.

**TA success definition:**
- Prospects use an isolated RNG stream `prospects` with stable subkeys.
- When **no prospects are accepted**, baseline **core outputs** for golden seeds match v0.2.2 exactly.
- ProspectsWindow schema + required structured log events match contract.
- BoundedSnapshot remains bounded; prospects data does not bloat snapshots.

---

## 1) Determinism + RNG isolation
### ✅ Green (safe if followed)
- Baseline RNG architecture already supports true stream isolation: seed is derived from `(run_seed|stream|turn_index|subkey)` (`src/sim/rng.ts`). Adding a new stream key **does not perturb** other streams *if the key is distinct*.
- v0.2.2 worldgen implementation demonstrates the intended pattern: dedicated stream (`worldgen`) + fixed root subkey + stable iteration (`src/sim/worldgen.ts`). This is a good template for `prospects`.

### ❌ Red (must change / enforce before BE proceeds)
**RNG stream and subkey contract must be explicit and “type‑forked.”**
- Add `"prospects"` to `StreamKey` and **never** generate prospects from any existing stream.
- Use a stable root subkey (versioned):
  - `root = new Rng(run_seed, "prospects", turn_index, "prospects/v0.2.3")`
- Fork per prospect type **by constant strings**, not by iterating a list of types:
  - `marriageRng = root.fork("type:marriage")`
  - `grantRng = root.fork("type:grant")`
  - `claimRng = root.fork("type:inheritance_claim")`

**Why this is required:** adding a new prospect type later should not change the sequences used by existing types.

### ⚠️ Yellow (watch/mitigate)
- **Stable enumeration:** any prospect generation that walks registries must iterate in sorted order:
  - `Object.keys(houses).sort()`
  - stable child lists (`child_ids`) are already ordered; preserve that.
- **Stable “score → pick top N” merge:** if you combine candidate prospects across types, final selection should be deterministic:
  - stable sort `(score desc, id asc)` then take first 3.

---

## 2) Non‑perturbation contract (when no prospects accepted)
### ✅ Green (safe if followed)
- With isolated RNG + “effects apply only on accept,” prospects should be non‑perturbing by construction.
- The engine already supports a **bounded snapshot** (`boundedSnapshot()` in `src/sim/turn.ts`) used in turn logs; this is the right anchor for comparing core outputs.

### ❌ Red (must change / enforce)
**Preflight must include a real baseline comparison for golden seeds.**
Contract requires: “Non‑perturbation: if no prospects accepted, core economic outputs unchanged vs baseline for golden seeds.”

**Recommended test strategy (deterministic and no‑deps compatible):**
1. **Capture a v0.2.2 baseline signature file** (committed into v0.2.3 repo):
   - `docs/preflight/nonperturbation_v0.2.2_core_outputs.json`
2. In v0.2.3 `npm run preflight` (no‑deps), run the same golden seeds for a fixed horizon (e.g., 15 turns) under canonical policies with **forced “no prospect accept” behavior**.
3. Compare per‑turn “core outputs” signatures to the v0.2.2 baseline file.

**Define “core outputs” as an explicit projection (exact match required):**
- From `snapshot_after` (preferred):
  - `manor.bushels_stored, manor.coin, manor.unrest, manor.population`
  - `manor.farmers, manor.builders`
  - `manor.obligations.{tax_due_coin, tithe_due_bushels, arrears.coin, arrears.bushels, war_levy_due}`
  - `manor.improvements`, `manor.construction` (id + progress + required)
  - `relationships` (optional but recommended as a drift detector)
  - `game_over` (reason + turn)

**Important exclusions for the comparison:**
- Anything in `state.log` (already excluded from boundedSnapshot)
- Any ProspectsWindow / prospects events / shown_ids / hidden_ids / prospect metadata

**Where to snapshot/compare:**
- Compare `snapshot_after` for each processed turn (from each `TurnLogEntry`).
  - This avoids needing to reason about report formatting/strings and is already bounded.

### ⚠️ Yellow (watch/mitigate)
- The existing v0.2.2 no‑deps QA includes a determinism check hashing the entire `state.log`. v0.2.3 will change log contents; that’s fine.
  - The **new** non‑perturbation check must not compare full logs to v0.2.2; compare the core projection only.

---

## 3) Schema + logs contract adherence
### ✅ Green (safe if followed)
- Contract is crisp: `ProspectsWindow` schema_version `"prospects_window_v1"`, `prospects` bounded `N ≤ 3`, plus `shown_ids` and `hidden_ids`.

### ❌ Red (must change / enforce)
**Structured log events must exist with exact names + required fields.**
Contract requires these exact event names in the turn log:
- `prospect_generated` (one per generated prospect)
- `prospects_window_built` (once per turn if any prospects generated; includes `shown_ids`/`hidden_ids`)
- `prospect_accepted`
- `prospect_rejected`
- `prospect_expired`

**TA recommendation (to minimize schema churn):**
- Add a new optional field to `TurnLogEntry`, e.g. `engine_log?: EngineLogEvent[]`.
  - This keeps `TurnReport` stable and avoids mixing with the existing `events: EventResult[]`.
- Ensure the event array order is deterministic:
  - `prospect_generated` sorted by `prospect_id`
  - then `prospects_window_built`
  - then any `accepted/rejected/expired` events sorted by `prospect_id`

**ProspectsWindow invariants (enforce in code + in preflight):**
- `schema_version === "prospects_window_v1"`
- `prospects.length <= 3`
- `shown_ids` and `hidden_ids` are disjoint
- `shown_ids ∪ hidden_ids == prospects.map(p => p.id)` (no unknown ids)
- `prospects_window_built` includes both arrays exactly as emitted

### ⚠️ Yellow (watch/mitigate)
- Be careful not to “string‑log” these events into `report.notes`; you will fail the contract because required fields are not representable.

---

## 4) Snapshot bounds / growth risk
### ✅ Green (safe if followed)
- `boundedSnapshot()` is already locked to exclude `log` and must remain that way.

### ❌ Red (must change / enforce)
**Do NOT store prospects payloads inside any field included in bounded snapshots**:
- Do not put prospects into `state.flags` (flags are included in boundedSnapshot).
- Do not add prospects catalogs to `people/houses` registries.

**Where ProspectsWindow should live (recommended):**
- **TurnContext output** (like `marriage_window`) for UI rendering.
- **TurnLogEntry** (bounded) for auditability *if desired* (e.g., `prospects_window?: ProspectsWindow`).
- If you need persistence for expiry across turns:
  - store only **minimal active prospect refs** in a dedicated `state.prospects_state` field,
  - keep it strictly bounded (≤3 active),
  - and keep it **out of boundedSnapshot()**.

### ⚠️ Yellow (watch/mitigate)
- Even bounded prospects add to `state.log` size over long runs. Keep `Prospect.summary`, `requirements.text`, and `predicted_effects` concise.

---

## Green / Yellow / Red roll‑up
### ✅ Green
- RNG architecture supports stream isolation.
- Existing patterns (worldgen) show stable IDs + idempotence + sorted iteration.
- boundedSnapshot already prevents runaway OOM by excluding `log`.

### ⚠️ Yellow
- Any prospect generation that iterates registries must sort keys to avoid drift.
- Decide early where structured prospect log events live (`TurnLogEntry` preferred) to avoid UI churn.
- If persistence for expiry is needed, keep it bounded and out of snapshots.

### ❌ Red
- Must implement **dedicated `prospects` RNG stream** + **type‑forked subkeys**.
- Must implement **non‑perturbation preflight** comparing v0.2.3 core outputs to **v0.2.2 baseline signatures**.
- Must implement required **structured log events** with exact names + required fields.
- Must keep prospects payloads out of snapshot‑included fields (especially `flags`).

---

## Concrete implementation guardrails (engineering checklist)
1. **RNG isolation**
   - [ ] `StreamKey` includes `"prospects"`.
   - [ ] root subkey is versioned (`prospects/v0.2.3`).
   - [ ] per‑type forks use constant strings (`type:marriage`, etc.).
   - [ ] internal selection forks use stable keys (house_id/person_id/slot) and sorted enumeration.

2. **Deterministic IDs**
   - [ ] `Prospect.id` derived from stable components (recommended: `pr_${turn}_${type}_${from_house_id}_${subject_person_id ?? "-"}`) and never from array index without a stable sort.

3. **Logs contract**
   - [ ] Emit structured events with exact names.
   - [ ] Include required fields (`turn_index`, `type`, `from_house_id`, `to_house_id`, `prospect_id` except window_built, `effects_applied` on accept/reject/expire).
   - [ ] `prospects_window_built` includes `shown_ids` + `hidden_ids`.

4. **Non‑perturbation**
   - [ ] Preflight loads v0.2.2 baseline core signatures and compares against v0.2.3 outputs when no accepts.
   - [ ] Core outputs projection excludes all prospect metadata.

5. **Snapshot bounds**
   - [ ] No prospects stored in `flags`.
   - [ ] No changes to `boundedSnapshot()` allowed keys beyond the existing bounded set.

