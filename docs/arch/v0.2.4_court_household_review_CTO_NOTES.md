# v0.2.4 TA Review — CTO Integration Notes (LOCKED CALLS)
**Last Updated:** 2026-02-16  
**Source:** TA review `docs/arch/v0.2.4_court_household_review.md`

## ✅ Green (safe)
- Adding a new RNG stream key `court` is safe if officer generation uses ONLY that stream.
- People-First upsert should preserve unknown house fields; compatible with storing court officer ids on player house record.
- Snapshot recursion remains prevented; adding 3 people is safe if data stays small.

## ⚠️ Yellow (watch)
1) Legacy vs registry sync: if married flag updated only in registry OR only in legacy objects, it may be overwritten on sync. Update both.
2) Court headcount must dedupe unique alive IDs (avoid double-counting).
3) Snapshot size creep: boundedSnapshot currently copies people/houses wholesale; ok for v0.2.4 but must be filtered before later growth.

## ❌ Red (must enforce in v0.2.4)
R1) Dedicated RNG stream `court` (officers only)
- Add `"court"` to StreamKey union.
- Officers generated only via `new Rng(run_seed, "court", 0, "court_officers/v0.2.4")`.
- Role-stable forks: `role/steward`, `role/clerk`, `role/marshal`.

R2) Officer generation idempotent + non-destructive
- Persist officer IDs on player house record:
  - `houses[player_house_id].court_officers` (role -> person_id)
- If ids + people exist, do nothing; else upsert missing only.

R3) Consumption split must reconcile (same bushel pool)
- `court_consumption = court_headcount * BUSHELS_PER_PERSON_PER_YEAR * TURN_YEARS`
- `total_consumption = peasant_consumption + court_consumption`
- Deduct once from `manor.bushels_stored`, apply shortage consequences to total shortage.

R4) Marriage accept must add spouse to court roster deterministically
- Preferred: spouse person already exists and is referenced by the prospect (e.g., spouse_person_id).
- Accept updates are pure state updates:
  - subject married=true (update legacy + registry)
  - add spouse id to `houses[player_house_id].court_extra_ids` (dedupe)
  - add spouse_of kinship edge if tracked
- If spouse must be generated at accept time (avoid if possible): must use isolated stream keyed by prospect_id (not `court`).

## Storage recommendation (v0.2.4 safe)
- Persist only small ID lists on house record (`court_officers`, `court_extra_ids`).
- Do not persist derived counts/consumption; compute in TurnReport.
