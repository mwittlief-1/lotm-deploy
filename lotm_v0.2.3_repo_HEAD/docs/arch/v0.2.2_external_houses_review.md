# v0.2.2 External Houses Seed — TA Review (Determinism + Bounded State + Migration Safety)
**Last Updated:** 2026-02-14

**Baseline BUILD_INFO fingerprint:** `d0a41c6cc6c36c93ea8f789e7da11fb0f32cab7b7b258e7f108e62b98e55bc92` (v0.2.1 repo CERTIFIED_QA)

## Summary
v0.2.2 introduces a **deterministic external world seed** (5–10 external Houses + their Persons) **inside the existing People/Houses registries** and surfaces them via a minimal “Known Houses” UI section.

Explicitly **not** in scope: multi-manor/holdings simulation, prospects engine, new screens/routes, or any new gameplay systems.

**TA headline:** This is safe **if** (1) external seed uses a dedicated RNG stream (`worldgen`) and (2) the current v0.2.1 People-First sync is made **non-destructive** (it currently rebuilds registries from legacy fields and would wipe external houses).

---

## 1) Worldgen RNG stream isolation (must not perturb existing sim)
### Required contract
- Add `"worldgen"` to `StreamKey` and ensure it is **only** used for external seed.
- External seed RNG must be derived from **(run_seed, stream="worldgen", turn_index=0, subkey=...)**.
- No additional RNG calls may be introduced in existing streams (`weather/events/household/marriage/ai/market`) as part of worldgen.

### Subkey guidance (stable + future-proof)
Use a versioned root subkey and fork by deterministic IDs:
- Root: `external_houses/v0.2.2`
- Per-house: `house:<house_id>`
- Per-person: `person:<person_id>`

This ensures future additions (v0.2.3 prospects) can live under a distinct subkey without changing v0.2.2 outputs.

---

## 2) Deterministic IDs (Houses + Persons)
### House IDs
Deterministic, index-based, fixed-width:
- `h_ext_01` … `h_ext_10`

### Person IDs within external houses
Deterministic, derived from house id:
- `p_ext_01_head`, `p_ext_01_spouse`, `p_ext_01_child1`, `p_ext_01_child2`

Notes:
- Keep existing v0.1/v0.2.1 IDs **unchanged** (e.g., `p_head`, `p_spouse`, `p_child1`, locals `p_noble1..`).
- Do **not** use name-derived IDs.

### Naming + house labels
- Names can remain RNG-picked (worldgen stream), but UI disambiguation should use existing v0.2.1 policy (age / suffix).
- House display label can be computed (e.g., `House <Surname>`), but its **data dependencies must be deterministic**.

---

## 3) People-First sync: critical non-destructive change
### Current v0.2.1 behavior (risk)
`ensurePeopleFirst()` currently calls `syncPeopleFirstFromLegacy()` whenever registries exist.
That function **rebuilds** `people` and **overwrites** `houses[player_house_id]` based solely on legacy `state.house/state.locals`.

**Problem:** Any externally seeded `houses` / `people` entries will be lost on the next `ensurePeopleFirst()` call (which occurs in `createNewRun()` and each resolved turn).

### Required v0.2.2 behavior
Keep legacy fields authoritative **for the player manor only**, while treating registries as the superset.

Minimum safe approach:
1) Start from existing registries (`s.people`, `s.houses`) if present.
2) Upsert/overwrite only:
   - `people[p_head/p_spouse/p_child*]` and current locals (liege/clergy/nobles)
   - `houses[h_player]` (player house record)
3) Preserve all other `people/*` and `houses/*` keys untouched.
4) When producing a “sorted” people object for stable serialization, include **all** people keys and sort.

This avoids introducing new gameplay while keeping seeded world data persistent.

---

## 4) Relationship edges seeding (A/R/T)
### Scope-safe recommendation
- Seed edges between **player head** and each **external head** in both directions:
  - `ensureEdge(p_head -> ext_head)` and `ensureEdge(ext_head -> p_head)`
- Optional: add spouse linkage later (not required for v0.2.2).

### Determinism/perf notes
- Create edges in a stable order (by sorted `house_id`), so the `relationships[]` array order is stable.
- For 5–10 houses, current `ensureEdge` O(E) search is fine.
- If v0.2.3 increases edges materially, consider an internal index map (defer unless needed).

---

## 5) Heir indicators: stored vs derived
**Recommendation: derive, do not store** (prevents drift across turns and migrations).

Derive on-demand from:
- `houses[h].head_id` + `houses[h].child_ids`
- `people[child_id].sex` and `alive`

Suggested derived states for UI:
- `Has heir` = any alive male child
- `Heiress possible` = no alive male child AND any alive female child
- `No heir` = no alive children (or none alive)

If the external seed does not model children for some houses, this will naturally yield `No heir`.

---

## 6) Bounded snapshots + export/packet implications
### Snapshot bounding
`boundedSnapshot()` currently copies `people` and `houses` wholesale. With 5–10 houses this remains acceptable.

**Guardrail for v0.2.3:** introduce a filtering step before prospects land:
- Snapshot should include only:
  - player house + locals
  - “known houses” and their immediate household members
  - relationships where both endpoints are in the snapshot person set

### Export evidence
For QA/UX validation, ensure at least one exported run includes:
- `houses` + `people` with external entries
- relationship edges linking player head to external heads
- a visible “Known Houses” UI section rendered from those registries

---

## 7) Migration / back-compat expectations
- v0.2.2 must still load v0.1.0 saves by:
  1) running v0.2.1 People-First migration
  2) applying v0.2.2 external seed **if not already seeded**

**Idempotence flag:** add an internal flag in `state.flags` (underscore-prefixed) e.g.:
- `_worldgen_external_houses_v0_2_2: true`

Seed must be applied only when this flag is absent/false.

---

## Risks + mitigations
### Determinism drift
- **Risk:** external seed uses non-worldgen RNG stream or adds calls to existing streams.
  - **Mitigation:** enforce `StreamKey="worldgen"` and centralize seeding in one function; add QA assertion that existing per-turn RNG-dependent outputs match prior golden seeds for identical decisions.
- **Risk:** registry enumeration without sorting creates platform/order differences.
  - **Mitigation:** sort by `house_id` (and then person_id) whenever building arrays that influence ordering (UI lists, edge creation).

### Graph / state blow-up
- **Risk:** unbounded registries copied into snapshots once prospects arrive.
  - **Mitigation:** implement snapshot filtering before v0.2.3.

### UI churn
- **Risk:** “Known Houses” depends on unstable ordering or missing IDs.
  - **Mitigation:** UI should render by `sorted(Object.keys(houses).filter(ext))` and tolerate missing optional fields.

### Save incompatibility
- **Risk:** People-First sync wipes external houses (data loss on load/turn).
  - **Mitigation:** make sync non-destructive (Section 3).

---

## Implementation checklist (engineer-facing)
| Item | Must be true | Notes |
|---|---|---|
| RNG isolation | All external seed randomness uses `stream="worldgen"`, `turnIndex=0` | No new calls in other streams |
| Idempotent seed | `_worldgen_external_houses_v0_2_2` prevents double-seed | Deterministic given run_seed |
| Stable IDs | `h_ext_01..` and `p_ext_01_*` scheme | No name-derived IDs |
| Non-destructive People-First sync | External `houses/people` persist after `ensurePeopleFirst()` | v0.2.1 sync currently breaks this |
| Sorted iteration | External house list + edge creation sorted by `house_id` | Avoid `Object.values()` unordered usage |
| Derived heir indicators | UI computes heir state from people+child_ids | Avoid stored drift |
| Snapshot bounded | OK for 5–10 houses; add filtering before prospects | Ensure no nested log/history |
